# .gitlab-ci.yml

stages:
  - build
  - test
  - cleanup


before_script:
  - export src_dir=${CI_PROJECT_DIR}
  - export git_hash=${CI_COMMIT_SHA:0:6}
  - export pb_dir="${CI_PROJECT_DIR}-build-${git_hash}"
  - hostname
  - whoami
  - pwd
  - echo "Sources - ${src_dir}"
  - echo "Commit - ${git_hash}"
  - echo "Project build - ${pb_dir}"

##############################################################
### BUILD


Mac-build:

  stage: build

  script:
    - mkdir -p ${pb_dir}/llvm
    - cd ${pb_dir}/llvm
    - cmake
          -DCMAKE_CXX_COMPILER=g++
          -DCMAKE_C_COMPILER=gcc
          -DCMAKE_BUILD_TYPE=Release
          -DBUILD_ALL_DEP=ON
          -DUSE_CUDA=ON
          -DUSE_OPENCL=ON
          -DUSE_SSE=ON
          -DUSE_OPENMP=OFF
          -DBUILD_TESTING=ON
          -DTESTING_2D_FILE=${src_dir}/reg-test/target_2D.nii.gz
          -DTESTING_3D_FILE=${src_dir}/reg-test/target_3D.nii.gz
          ${src_dir}
    - cmake
          -DCMAKE_CXX_COMPILER=g++
          -DCMAKE_C_COMPILER=gcc
          -DCMAKE_BUILD_TYPE=Release
          -DBUILD_ALL_DEP=ON
          -DUSE_CUDA=ON
          -DUSE_OPENCL=ON
          -DUSE_SSE=ON
          -DUSE_OPENMP=OFF
          -DBUILD_TESTING=ON
          -DTESTING_2D_FILE=${src_dir}/reg-test/target_2D.nii.gz
          -DTESTING_3D_FILE=${src_dir}/reg-test/target_3D.nii.gz
          ${src_dir}
    - make -j 4
    - mkdir -p ${pb_dir}/gnu
    - mkdir -p ${pb_dir}/gnu/reg-test
    - cd ${pb_dir}/gnu
    - cp -R ${pb_dir}/llvm/reg-test/test-data ${pb_dir}/gnu/reg-test/test-data
    - cmake
          -DCMAKE_CXX_COMPILER=g++-7
          -DCMAKE_C_COMPILER=gcc-7
          -DCMAKE_BUILD_TYPE=Release
          -DBUILD_ALL_DEP=ON
          -DUSE_CUDA=ON
          -DCUDA_HOST_COMPILER=/usr/bin/clang
          -DUSE_OPENCL=ON
          -DUSE_SSE=ON
          -DUSE_OPENMP=ON
          -DBUILD_TESTING=ON
          -DTESTING_2D_FILE=${src_dir}/reg-test/target_2D.nii.gz
          -DTESTING_3D_FILE=${src_dir}/reg-test/target_3D.nii.gz
          ${src_dir}
    - cmake
          -DCMAKE_CXX_COMPILER=g++-7
          -DCMAKE_C_COMPILER=gcc-7
          -DCMAKE_BUILD_TYPE=Release
          -DBUILD_ALL_DEP=ON
          -DUSE_CUDA=ON
          -DCUDA_HOST_COMPILER=/usr/bin/clang
          -DUSE_OPENCL=ON
          -DUSE_SSE=ON
          -DUSE_OPENMP=ON
          -DBUILD_TESTING=ON
          -DTESTING_2D_FILE=${src_dir}/reg-test/target_2D.nii.gz
          -DTESTING_3D_FILE=${src_dir}/reg-test/target_3D.nii.gz
          ${src_dir}
    - make -j 4

  only:
    - branches

  tags:
    - mac


Linux-build:

  stage: build

  script:
    - mkdir -p ${pb_dir}
    - cd ${pb_dir}
    - cmake
          -DCMAKE_BUILD_TYPE=Release
          -DBUILD_ALL_DEP=ON
          -DUSE_CUDA=ON
          -DUSE_OPENCL=ON
          -DUSE_SSE=ON
          -DUSE_OPENMP=ON
          -DBUILD_TESTING=ON
          -DTESTING_2D_FILE=${src_dir}/reg-test/target_2D.nii.gz
          -DTESTING_3D_FILE=${src_dir}/reg-test/target_3D.nii.gz
          ${src_dir}
    - make -j 4

  only:
    - branches

  tags:
    - linux


##############################################################
### TEST


Mac-test:

  stage: test

  script:
    - cd ${pb_dir}/llvm
    - ctest -V
    - cd ${pb_dir}/gnu
    - ctest -V

  only:
    - branches

  tags:
    - mac


Linux-test:

  stage: test

  script:
    - cd ${pb_dir}
    - ctest -V

  only:
    - branches

  tags:
    - mac


##############################################################
### CLEAN


Mac-Cleanup:

  stage: cleanup

  script:
    - rm -rf ${pb_dir}

  when: always

  only:
    - branches

  tags:
    - mac


Linux-Cleanup:

  stage: cleanup

  script:
    - rm -rf ${pb_dir}

  when: always

  only:
    - branches

  tags:
    - linux
